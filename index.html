<!DOCTYPE html>
<html>
<head>
    <title>Amugona Chat</title>
    <!-- Bootstrap core CSS -->
    <!-- 합쳐지고 최소화된 최신 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- 부가적인 테마 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <style>
        body {
            font-family: "나눔바른펜";
            height: 100%;

            overflow-x: hidden;
            overflow-y: scroll;
        }

        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .createPage, .namePage, .detailPage, .invitePage, .bangChat {
            display: none;
        }

        /* Input & Button Style */
        input, button {
            padding: 5px 10px;
            height: 30px;
            border: 1px solid #eee;
            border-radius: 7px;
        }

        input {
            width: 220px;
        }

        button {
            width: 140px;
        }

        input:hover {
            border-color: #ccc;
        }

        button:hover {
            background-color: #ccc;
        }

        input:focus, button:focus {
            border-color: #4272bd;
            outline: none;
        }

        /* page */
        .bangPage {
            padding: 10px;
        }

        .form-signin {  /* form center */
            max-width: 330px;
            padding: 15px;
            margin: 0 auto;
        }

        /* bang Chat */
        .bangChat {
            padding: 5px 10px;
        }

        .nav {
            background-color: #eee;
            height: 900px;
            padding: 5px 10px;
        }

        .header {
            height: 15%;
            margin-bottom: .5%;
        }
        .content {
            height: 80%;
        }

        /* messages */
        .log {
            color: rgb(236, 121, 102);
            text-align: center;
        }

        #messages { list-style: none; }

        #inputMessage {
            position: fixed;
            margin-right: 10px;
            width: 83%;
            bottom: 0;
            right: 0;
        }
    </style>

</head>
<body>
    <div class="pages">

        <!-- main page -->
        <div class="mainPage center">
            <h1>Hello World!</h1>
            <form id="mainPage">
                <input id="inputEmail" placeholder="email">
                <button>Create new Bang</button>
            </form>
        </div>

        <!-- create page -->
        <div class="createPage">

            <!-- bang name -->
            <div class="bangPage">
                <form id="bangPage" class="form-signin">
                    <h1>Edit your Bang Name</h1>
                    <input class="form-control" id="inputBangName" type="text" placeholder="BangName">
                    <input class="form-control" id="inputBangAddr" type="text" placeholder="BangAddress">
                    <label>.amugona.com</label>
                    <button>Next</button>
                </form>
            </div>

            <!-- name & nickname -->
            <div class="namePage">
                <form id="namePage" class="form-signin">
                    <h1>Edit your name</h1>
                    <p>
                        your name
           
                        <input class="form-control" id="inputUsername" type="text" placeholder="name">
                    </p>
                    <button>Next</button>
                </form>
            </div>

            <!-- detail -->
            <div class="detailPage">
                <form id="detailPage" class="form-signin">
                    <h1>Profile Detail</h1>
                    <p>Bang Name</p>
                    <input class="form-control" id="editBangName" placeholder="bang name">
                    <p>Bang Address</p>
                    <input class="form-control" id="editBangAddr" placeholder="bang address">
                    <p>Name</p>
                    <input class="form-control" id="editUsername" placeholder="name">
                    <p>Email</p>
                    <input class="form-control" id="editEmail" placeholder="email">
                    <button>Create</button>
                </form>
            </div>
        </div>

        <!-- Chat Room -->
        <div class="bangChat">
            <div class="row">
                <div class="col-md-2">
                    <ul class="nav">
                        <li>방이름</li>
                        <li>
                            칸막이
                            <span class="glyphicon glyphicon-plus-sign" data-toggle="modal" data-target="#addKanmagi"></span>

                            <!-- Modal -->
                            <div class="modal fade" id="addKanmagi" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title" id="myModalLabel">Create a kanmagi</h4>
                                  </div>
                                  <div class="modal-body">
                                    <label class="control-label">Kanmagi Name</label>
                                    <input type="text" class="form-control" id="inputKanmagiName">
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="createKanmagi">Create kanmagi</button>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <ul class="kanmagi">
                                <li>
                                    <a href="">General</a>
                                </li>
                            </ul>
                        </li>
                        <li>유저</li>
                    </ul>
                </div>
                <div class="col-md-10">
                    <!-- 칸막이 정보 -->
                    <div class="header">
                        <h1>칸막이이름<br>
                            <small>멤버수</small>
                            <small>칸막이설명</small>
                        </h1>
                        <hr>
                    </div>

                    <!-- 채팅창 -->
                    <div class="content">
                        <form id="chatPage">
                            <ul id="messages"></ul>
                            <input type="text" id="inputMessage" placeholder="type here...">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script>
        var $window = $(window);

        /* input */
        var $inputEmail = $('#inputEmail');
        var $inputBangName = $('#inputBangName');
        var $inputBangAddr = $('#inputBangAddr');
        var $inputUsername = $('#inputUsername');
        var $inputMessage = $('#inputMessage');   // input message

        /* edit */
        var $editEmail = $('#editEmail');
        var $editBangName = $('#editBangName');
        var $editBangAddr = $('#editBangAddr');
        var $editUsername = $('#editUsername');

        /* variable init */
        var BangName;
        var BangAddr;
        var Username;
        var Email;

        /* page */
        var $mainPage = $('.mainPage');
        var $createPage = $('.createPage');
        var $namePage = $('.namePage');
        var $bangPage = $('.bangPage');
        var $detailPage = $('.detailPage');
        var $bangChat = $('.bangChat'); // message page

        /* message area */
        var $messages = $('#messages');

        /* focus input */
        var $currentInput = $inputEmail.focus();

        /* client socket */
        var socket = io();

        /* fucntion */

        function cleanInput() {
            $inputMessage.val('');
        }

        // get message and emit 'send message'
        function sendMessage() {
            var message = $inputMessage.val();
            cleanInput();
            
            //(챗-1)본인이 입력한 챗 메시지를 본인 화면에 출력
            addChatMessage({ username: Username, message: message });
            
            //(챗-2)서버에게 이벤트를 쏜다
            socket.emit('send message', { username: Username, message: message });
        }

        // create li element
        function addChatMessage(data) {
            var $usernameDiv = $('<span>').text("[" + data.username + "] ");
            var $messageDiv = $('<span>').text(data.message);
            var $el = $('<li>').append($usernameDiv, $messageDiv);
            addMessageElement($el);
        }

        // add messsage
        function addMessageElement(el) {
            $messages.append(el);
            $(document).scrollTop($(document).height());
        }

        function log(data) {
            var el = $('<li>').addClass('log').text(data);
            addMessageElement(el);
        }

        //환영합니다. 현재 n명 접속중입니다.(첫 접속시)
        //(타사용자 접속시)000님이 접속하셨습니다.
        function addParticipantMessage(data, msg) {
            var str = msg + data.numUsers + "명 접속중입니다.";
            log(str);
        }

        /* Modal */
        var kanmagiName = "";
        $('#createKanmagi').click(function () {
            kanmagiName = $('#inputKanmagiName').val();
            $('#addKanmagi').modal('hide'); // data-dismiss="modal"
            $('.kanmagi').append($('<li>').text(kanmagiName));
            return false;
        });

        /* form submit */
        $('#mainPage').submit(function () {
            Email = $inputEmail.val();

            $mainPage.fadeOut();
            $createPage.show();
            $currentInput = $inputBangName.focus();
            return false;
        });

        $('#bangPage').submit(function () {
            BangName = $inputBangName.val();
            BangAddr = $inputBangAddr.val();

            $namePage.show();
            $bangPage.fadeOut();
            $currentInput = $inputUsername.focus();
            return false;
        });

        $('#namePage').submit(function () {
            Username = $inputUsername.val();

            // set input
            $editEmail.val(Email);
            $editBangName.val(BangName);
            $editBangAddr.val(BangAddr);
            $editUsername.val(Username);

            $detailPage.show();
            $namePage.fadeOut();
            $currentInput = $('button').focus();
            return false;
        });

        $('#detailPage').submit(function () {
            $detailPage.fadeOut();
            $bangChat.show();

            //서버에 이름을 보낸다. emit으로 이벤트 발생 on으로 그 이벤트에 대한 처리
            socket.emit('add user', Username);
            
            //서버에 이메일 보낸다
            socket.emit('send email', Email);
            
            $currentInput = $inputMessage.focus();
            return false;
        });

        $('#chatPage').submit(function () {
            sendMessage();

            return false;
        });

        // socket event
        socket.on('user joined', function (data) {
            var msg = data.username + "님이 접속하셨습니다.";
            log(msg);
        });

        //(챗-4)남에게 온 챗 메시지를 출력
        socket.on('send message', function (data) {
            addChatMessage(data);
        });

        socket.on('welcome', function (data) {
            var msg = Username + "님 환영합니다!";
            addParticipantMessage(data, msg);
        });

        socket.on('user left', function (data) {
            var msg = data.username + "님이 나가셨습니다.";
            addParticipantMessage(data, msg);
        });
        

    </script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
    <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>
</html>
